<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>List Randomizer with Constraints</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #ff6b6b, #feca57);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .workflow-container {
            padding: 40px;
        }

        .step {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 25px;
            border-left: 5px solid #ddd;
            position: relative;
            transition: all 0.3s ease;
        }

        .step.completed {
            border-left-color: #28a745;
            background: #f8fff8;
        }

        .step.active {
            border-left-color: #feca57;
            background: #fffef8;
            box-shadow: 0 5px 15px rgba(254, 202, 87, 0.2);
        }

        .step.disabled {
            opacity: 0.6;
            pointer-events: none;
        }

        .step-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
        }

        .step-number {
            background: #ddd;
            color: #666;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.2rem;
            transition: all 0.3s ease;
        }

        .step.completed .step-number {
            background: #28a745;
            color: white;
        }

        .step.active .step-number {
            background: #feca57;
            color: #333;
        }

        .step-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: #333;
        }

        .step-description {
            color: #666;
            font-size: 0.95rem;
            margin-top: 5px;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #555;
        }

        .list-input {
            width: 100%;
            min-height: 150px;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 1rem;
            font-family: inherit;
            resize: vertical;
            transition: border-color 0.3s ease;
        }

        .list-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .multi-select {
            width: 100%;
            max-height: 200px;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 10px;
            background: white;
            overflow-y: auto;
        }

        .select-item {
            display: flex;
            align-items: center;
            padding: 8px 12px;
            margin: 2px 0;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .select-item:hover {
            background: #f0f4ff;
        }

        .select-item.selected {
            background: #e3f2fd;
            border: 1px solid #2196f3;
        }

        .select-item input[type="checkbox"] {
            margin-right: 10px;
            transform: scale(1.2);
        }

        .dropdown {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 1rem;
            background: white;
        }

        .action-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s ease;
            margin-right: 10px;
        }

        .action-btn:hover {
            background: #5a6fd8;
            transform: translateY(-1px);
        }

        .action-btn.secondary {
            background: #6c757d;
        }

        .action-btn.primary {
            background: #28a745;
            padding: 15px 40px;
            border-radius: 50px;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .action-btn.primary:hover {
            background: #218838;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(40, 167, 69, 0.3);
        }

        .summary-box {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }

        .summary-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .summary-item:last-child {
            border-bottom: none;
        }

        .tag {
            background: #e3f2fd;
            color: #1976d2;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            margin: 2px;
            display: inline-block;
        }

        .tag.exclusion {
            background: #fff3e0;
            color: #f57c00;
        }

        .tag.absent {
            background: #ffebee;
            color: #d32f2f;
        }

        .constraint-item {
            background: white;
            padding: 10px 15px;
            margin: 5px 0;
            border-radius: 8px;
            border: 1px solid #dee2e6;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .constraint-item button {
            background: #dc3545;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
        }

        .constraint-item button:hover {
            background: #c82333;
        }

        .status-text {
            font-weight: 500;
            margin-top: 15px;
        }

        .status-text.success {
            color: #28a745;
        }

        .status-text.info {
            color: #667eea;
        }

        .checkmark {
            color: #28a745;
            font-weight: bold;
        }

        .results-section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 30px;
            margin-top: 30px;
            display: none;
        }

        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .result-group {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .group-title {
            font-weight: 600;
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.1rem;
        }

        .group-items {
            list-style: none;
        }

        .group-items li {
            padding: 8px 12px;
            margin: 5px 0;
            background: #f8f9fa;
            border-radius: 6px;
            border-left: 4px solid #667eea;
        }

        .group-items li.absent {
            border-left-color: #dc3545;
            background: #fff5f5;
            color: #721c24;
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border: 1px solid #f5c6cb;
        }

        .info-message {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border: 1px solid #c3e6cb;
        }

        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .workflow-container {
                padding: 20px;
            }
            
            .step {
                padding: 20px;
            }
            
            .step-header {
                flex-direction: column;
                text-align: center;
                gap: 10px;
            }
            
            .summary-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🎲 List Randomizer with Constraints</h1>
            <p>Organize your class with smart constraints in 5 easy steps</p>
        </div>

        <div class="workflow-container">
            <!-- Step 1: Add Class List -->
            <div class="step active" id="step1">
                <div class="step-header">
                    <div class="step-number">1</div>
                    <div>
                        <div class="step-title">Add Your Full Class List</div>
                        <div class="step-description">Paste your complete prepared list - everyone who should be in class today</div>
                    </div>
                </div>
                
                <div class="input-group">
                    <label class="input-label">Class List (one name per line):</label>
                    <textarea class="list-input" id="classList" placeholder="Alice&#10;Bob&#10;Charlie&#10;Diana&#10;Eve&#10;Frank&#10;Grace&#10;Henry"></textarea>
                </div>
                
                <div id="step1Status" class="status-text info" style="display: none;"></div>
                
                <button class="action-btn" onclick="completeStep1()" id="step1Btn" disabled>Continue to Position Exclusions</button>
            </div>

            <!-- Step 2: Position Exclusions -->
            <div class="step disabled" id="step2">
                <div class="step-header">
                    <div class="step-number">2</div>
                    <div>
                        <div class="step-title">Who Can't Be First Again?</div>
                        <div class="step-description">Select students who were in the first positions last time and shouldn't be there again</div>
                    </div>
                </div>
                
                <div class="input-group">
                    <label class="input-label">Select students to exclude from first positions:</label>
                    <div class="multi-select" id="exclusionSelect" style="display: none;">
                        <!-- Populated dynamically -->
                    </div>
                </div>
                
                <div class="input-group">
                    <label class="input-label">Number of positions to exclude from:</label>
                    <input type="number" value="4" min="1" id="exclusionCount" style="width: 100px; padding: 8px; border: 2px solid #ddd; border-radius: 5px;">
                    <span style="margin-left: 10px; color: #666;">positions</span>
                </div>
                
                <div id="step2Status" class="status-text info" style="display: none;"></div>
                
                <button class="action-btn secondary" onclick="skipStep2()">Skip This Step</button>
                <button class="action-btn" onclick="completeStep2()" id="step2Btn">Continue to Exclusion Pairs</button>
            </div>

            <!-- Step 3: Exclusion Pairs -->
            <div class="step disabled" id="step3">
                <div class="step-header">
                    <div class="step-number">3</div>
                    <div>
                        <div class="step-title">Students Who Can't Be Together</div>
                        <div class="step-description">Select pairs of students who shouldn't be in the same group</div>
                    </div>
                </div>
                
                <div class="input-group">
                    <label class="input-label">Select first student:</label>
                    <select class="dropdown" id="pairStudent1">
                        <option value="">Choose a student...</option>
                    </select>
                </div>
                
                <div class="input-group">
                    <label class="input-label">Select second student:</label>
                    <select class="dropdown" id="pairStudent2">
                        <option value="">Choose a student...</option>
                    </select>
                </div>
                
                <button class="action-btn" onclick="addExclusionPair()" id="addPairBtn" disabled>Add Exclusion Pair</button>
                
                <div id="exclusionPairsList" style="margin-top: 20px;"></div>
                
                <div id="step3Status" class="status-text info" style="display: none;"></div>
                
                <button class="action-btn secondary" onclick="skipStep3()">Skip This Step</button>
                <button class="action-btn" onclick="completeStep3()" id="step3Btn">Continue to Absent Students</button>
            </div>

            <!-- Step 4: Absent Students -->
            <div class="step disabled" id="step4">
                <div class="step-header">
                    <div class="step-number">4</div>
                    <div>
                        <div class="step-title">Who's Absent or Late Today?</div>
                        <div class="step-description">Mark students who aren't here yet - they'll be placed according to your preference</div>
                    </div>
                </div>
                
                <div class="input-group">
                    <label class="input-label">Select absent/late students:</label>
                    <div class="multi-select" id="absentSelect" style="display: none;">
                        <!-- Populated dynamically -->
                    </div>
                </div>
                
                <div class="input-group">
                    <label class="input-label">Where should absent students go?</label>
                    <select class="dropdown" id="absentPlacement">
                        <option value="last">Distribute through last groups (recommended)</option>
                        <option value="spread">Spread evenly across all groups</option>
                        <option value="separate">Keep all in final groups</option>
                    </select>
                </div>
                
                <div id="step4Status" class="status-text info" style="display: none;"></div>
                
                <button class="action-btn secondary" onclick="skipStep4()">Skip This Step</button>
                <button class="action-btn" onclick="completeStep4()" id="step4Btn">Continue to Final Settings</button>
            </div>

            <!-- Step 5: Final Settings -->
            <div class="step disabled" id="step5">
                <div class="step-header">
                    <div class="step-number">5</div>
                    <div>
                        <div class="step-title">Final Settings & Generate</div>
                        <div class="step-description">Review your settings and generate the randomized groups</div>
                    </div>
                </div>
                
                <div class="summary-box" id="summaryBox">
                    <h4 style="margin-bottom: 15px; color: #333;">Summary</h4>
                    <!-- Populated dynamically -->
                </div>
                
                <div class="input-group">
                    <label class="input-label">Group Size:</label>
                    <input type="number" value="3" min="1" id="groupSize" style="width: 100px; padding: 12px; border: 2px solid #ddd; border-radius: 8px;">
                </div>
                
                <div style="text-align: center; margin-top: 30px;">
                    <button class="action-btn primary" onclick="generateGroups()" id="generateBtn">🎲 Generate Randomized Groups</button>
                </div>
            </div>
        </div>

        <div class="results-section" id="resultsSection">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="color: #333; font-size: 1.5rem;">🎯 Your Randomized Groups</h2>
                <button onclick="copyToExcel()" style="
                    padding: 10px 20px;
                    background: #28a745;
                    color: white;
                    border: none;
                    border-radius: 8px;
                    cursor: pointer;
                    font-size: 1rem;
                    transition: background 0.3s ease;
                " onmouseover="this.style.background='#218838'" onmouseout="this.style.background='#28a745'">
                    📋 Copy for Excel
                </button>
            </div>
            <div id="messagesContainer"></div>
            <div class="results-grid" id="resultsGrid"></div>
        </div>
    </div>

    <script>
        // Global state
        var classData = {
            allStudents: [],
            excludedStudents: [],
            absentStudents: [],
            exclusionPairs: [],
            exclusionCount: 4,
            absentPlacement: 'last',
            groupSize: 3
        };

        // Step 1: Add class list
        document.getElementById('classList').addEventListener('input', function() {
            var students = this.value.split('\n')
                .map(function(s) { return s.trim(); })
                .filter(function(s) { return s.length > 0; });
            
            var btn = document.getElementById('step1Btn');
            var status = document.getElementById('step1Status');
            
            if (students.length > 0) {
                btn.disabled = false;
                status.style.display = 'block';
                status.className = 'status-text info';
                status.innerHTML = '📝 ' + students.length + ' students ready to add';
            } else {
                btn.disabled = true;
                status.style.display = 'none';
            }
        });

        function completeStep1() {
            var students = document.getElementById('classList').value.split('\n')
                .map(function(s) { return s.trim(); })
                .filter(function(s) { return s.length > 0; });
            
            classData.allStudents = students;
            
            // Update step 1 status
            var status = document.getElementById('step1Status');
            status.className = 'status-text success';
            status.innerHTML = '<span class="checkmark">✓</span> ' + students.length + ' students added successfully';
            
            // Mark step 1 complete and activate step 2
            document.getElementById('step1').classList.remove('active');
            document.getElementById('step1').classList.add('completed');
            document.getElementById('step1').querySelector('.step-number').innerHTML = '✓';
            
            document.getElementById('step2').classList.remove('disabled');
            document.getElementById('step2').classList.add('active');
            
            // Populate step 2
            populateExclusionSelect();
        }

        function populateExclusionSelect() {
            var select = document.getElementById('exclusionSelect');
            select.style.display = 'block';
            select.innerHTML = '';
            
            classData.allStudents.forEach(function(student, index) {
                var div = document.createElement('div');
                div.className = 'select-item';
                div.innerHTML = 
                    '<input type="checkbox" id="excl_' + index + '" onchange="updateExclusionSelection()">' +
                    '<span>' + student + '</span>';
                div.addEventListener('click', function(e) {
                    if (e.target.type !== 'checkbox') {
                        var checkbox = this.querySelector('input[type="checkbox"]');
                        checkbox.checked = !checkbox.checked;
                        updateExclusionSelection();
                    }
                });
                select.appendChild(div);
            });
        }

        function updateExclusionSelection() {
            var checkboxes = document.querySelectorAll('#exclusionSelect input[type="checkbox"]');
            var selectedStudents = [];
            
            checkboxes.forEach(function(checkbox, index) {
                var item = checkbox.closest('.select-item');
                if (checkbox.checked) {
                item.classList.add('selected');
                                } else {
                                    item.classList.remove('selected');
                                }
                            });
                            
                            classData.excludedStudents = selectedStudents;
                            
                            var status = document.getElementById('step2Status');
                            if (selectedStudents.length > 0) {
                                status.style.display = 'block';
                                status.className = 'status-text info';
                                status.innerHTML = '📍 ' + selectedStudents.length + ' students selected for position exclusion';
                            } else {
                                status.style.display = 'none';
                            }
                        }
                
                        function skipStep2() {
                            classData.excludedStudents = [];
                            completeStep2();
                        }
                
                        function completeStep2() {
                            classData.exclusionCount = parseInt(document.getElementById('exclusionCount').value) || 4;
                            
                            // Update step 2 status
                            var status = document.getElementById('step2Status');
                            status.className = 'status-text success';
                            if (classData.excludedStudents.length > 0) {
                                status.innerHTML = '<span class="checkmark">✓</span> ' + classData.excludedStudents.length + ' students excluded from first ' + classData.exclusionCount + ' positions';
                            } else {
                                status.innerHTML = '<span class="checkmark">✓</span> No position exclusions set';
                            }
                            
                            // Mark step 2 complete and activate step 3
                            document.getElementById('step2').classList.remove('active');
                            document.getElementById('step2').classList.add('completed');
                            document.getElementById('step2').querySelector('.step-number').innerHTML = '✓';
                            
                            document.getElementById('step3').classList.remove('disabled');
                            document.getElementById('step3').classList.add('active');
                            
                            // Populate step 3
                            populateExclusionPairsStep();
                        }
                
                        function skipStep2() {
                            classData.excludedStudents = [];
                            completeStep2();
                        }
                
                        function completeStep2() {
                            classData.exclusionCount = parseInt(document.getElementById('exclusionCount').value) || 4;
                            
                            // Update step 2 status
                            var status = document.getElementById('step2Status');
                            status.className = 'status-text success';
                            if (classData.excludedStudents.length > 0) {
                                status.innerHTML = '<span class="checkmark">✓</span> ' + classData.excludedStudents.length + ' students excluded from first ' + classData.exclusionCount + ' positions';
                            } else {
                                status.innerHTML = '<span class="checkmark">✓</span> No position exclusions set';
                            }
                            
                            // Mark step 2 complete and activate step 3
                            document.getElementById('step2').classList.remove('active');
                            document.getElementById('step2').classList.add('completed');
                            document.getElementById('step2').querySelector('.step-number').innerHTML = '✓';
                            
                            document.getElementById('step3').classList.remove('disabled');
                            document.getElementById('step3').classList.add('active');
                            
                            // Populate step 3
                            populateExclusionPairsStep();
                        }
                            var student1Select = document.getElementById('pairStudent1');
                            var student2Select = document.getElementById('pairStudent2');
                            
                            // Clear and populate both dropdowns
                            student1Select.innerHTML = '<option value="">Choose a student...</option>';
                            student2Select.innerHTML = '<option value="">Choose a student...</option>';
                            
                            classData.allStudents.forEach(function(student) {
                                var option1 = document.createElement('option');
                                option1.value = student;
                                option1.textContent = student;
                                student1Select.appendChild(option1);
                                
                                var option2 = document.createElement('option');
                                option2.value = student;
                                option2.textContent = student;
                                student2Select.appendChild(option2);
                            });
                            
                            // Add event listeners to enable/disable add button
                            function updateAddButton() {
                                var student1 = student1Select.value;
                                var student2 = student2Select.value;
                                var addBtn = document.getElementById('addPairBtn');
                                
                                addBtn.disabled = !student1 || !student2 || student1 === student2;
                            }
                            
                            student1Select.addEventListener('change', updateAddButton);
                            student2Select.addEventListener('change', updateAddButton);
                            
                            // Display existing pairs
                            displayExclusionPairs();
                        }
                
                        function addExclusionPair() {
                            var student1 = document.getElementById('pairStudent1').value;
                            var student2 = document.getElementById('pairStudent2').value;
                            
                            if (!student1 || !student2 || student1 === student2) return;
                            
                            // Check if pair already exists (in either order)
                            var pairExists = classData.exclusionPairs.some(function(pair) {
                                return (pair[0] === student1 && pair[1] === student2) || 
                                       (pair[0] === student2 && pair[1] === student1);
                            });
                            
                            if (pairExists) {
                                showMessage('This exclusion pair already exists!', 'error');
                                return;
                            }
                            
                            // Add the pair
                            classData.exclusionPairs.push([student1, student2]);
                            
                            // Reset dropdowns
                            document.getElementById('pairStudent1').value = '';
                            document.getElementById('pairStudent2').value = '';
                            document.getElementById('addPairBtn').disabled = true;
                            
                            // Update display
                            displayExclusionPairs();
                            updateStep3Status();
                        }
                
                        function displayExclusionPairs() {
                            var listDiv = document.getElementById('exclusionPairsList');
                            
                            if (classData.exclusionPairs.length === 0) {
                                listDiv.innerHTML = '';
                                return;
                            }
                            
                            var html = '<h5 style="margin-bottom: 10px; color: #333;">Exclusion Pairs:</h5>';
                            
                            classData.exclusionPairs.forEach(function(pair, index) {
                                html += '<div class="constraint-item">';
                                html += '<span>' + pair[0] + ' ↔ ' + pair[1] + '</span>';
                                html += '<button onclick="removeExclusionPair(' + index + ')">Remove</button>';
                                html += '</div>';
                            });
                            
                            listDiv.innerHTML = html;
                        }
                
                        function removeExclusionPair(index) {
                            classData.exclusionPairs.splice(index, 1);
                            displayExclusionPairs();
                            updateStep3Status();
                        }
                
                        function updateStep3Status() {
                            var status = document.getElementById('step3Status');
                            if (classData.exclusionPairs.length > 0) {
                                status.style.display = 'block';
                                status.className = 'status-text info';
                                status.innerHTML = '🚫 ' + classData.exclusionPairs.length + ' exclusion pairs set';
                            } else {
                                status.style.display = 'none';
                            }
                        }
                
                        function skipStep3() {
                            classData.exclusionPairs = [];
                            completeStep3();
                        }
                
                        function completeStep3() {
                            // Update step 3 status
                            var status = document.getElementById('step3Status');
                            status.className = 'status-text success';
                            if (classData.exclusionPairs.length > 0) {
                                status.innerHTML = '<span class="checkmark">✓</span> ' + classData.exclusionPairs.length + ' exclusion pairs set';
                            } else {
                                status.innerHTML = '<span class="checkmark">✓</span> No exclusion pairs set';
                            }
                            
                            // Mark step 3 complete and activate step 4
                            document.getElementById('step3').classList.remove('active');
                            document.getElementById('step3').classList.add('completed');
                            document.getElementById('step3').querySelector('.step-number').innerHTML = '✓';
                            
                            document.getElementById('step4').classList.remove('disabled');
                            document.getElementById('step4').classList.add('active');
                            
                            // Populate step 4
                            populateAbsentSelect();
                        }
                
                        function populateExclusionPairsStep() {
                            var student1Select = document.getElementById('pairStudent1');
                            var student2Select = document.getElementById('pairStudent2');
                            
                            // Clear and populate both dropdowns
                            student1Select.innerHTML = '<option value="">Choose a student...</option>';
                            student2Select.innerHTML = '<option value="">Choose a student...</option>';
                            
                            classData.allStudents.forEach(function(student) {
                                var option1 = document.createElement('option');
                                option1.value = student;
                                option1.textContent = student;
                                student1Select.appendChild(option1);
                                
                                var option2 = document.createElement('option');
                                option2.value = student;
                                option2.textContent = student;
                                student2Select.appendChild(option2);
                            });
                            
                            // Add event listeners to enable/disable add button
                            function updateAddButton() {
                                var student1 = student1Select.value;
                                var student2 = student2Select.value;
                                var addBtn = document.getElementById('addPairBtn');
                                
                                addBtn.disabled = !student1 || !student2 || student1 === student2;
                            }
                            
                            student1Select.addEventListener('change', updateAddButton);
                            student2Select.addEventListener('change', updateAddButton);
                            
                            // Display existing pairs
                            displayExclusionPairs();
                        }
                
                        function addExclusionPair() {
                            var student1 = document.getElementById('pairStudent1').value;
                            var student2 = document.getElementById('pairStudent2').value;
                            
                            if (!student1 || !student2 || student1 === student2) return;
                            
                            // Check if pair already exists (in either order)
                            var pairExists = classData.exclusionPairs.some(function(pair) {
                                return (pair[0] === student1 && pair[1] === student2) || 
                                       (pair[0] === student2 && pair[1] === student1);
                            });
                            
                            if (pairExists) {
                                showMessage('This exclusion pair already exists!', 'error');
                                return;
                            }
                            
                            // Add the pair
                            classData.exclusionPairs.push([student1, student2]);
                            
                            // Reset dropdowns
                            document.getElementById('pairStudent1').value = '';
                            document.getElementById('pairStudent2').value = '';
                            document.getElementById('addPairBtn').disabled = true;
                            
                            // Update display
                            displayExclusionPairs();
                            updateStep3Status();
                        }
                
                        function displayExclusionPairs() {
                            var listDiv = document.getElementById('exclusionPairsList');
                            
                            if (classData.exclusionPairs.length === 0) {
                                listDiv.innerHTML = '';
                                return;
                            }
                            
                            var html = '<h5 style="margin-bottom: 10px; color: #333;">Exclusion Pairs:</h5>';
                            
                            classData.exclusionPairs.forEach(function(pair, index) {
                                html += '<div class="constraint-item">';
                                html += '<span>' + pair[0] + ' ↔ ' + pair[1] + '</span>';
                                html += '<button onclick="removeExclusionPair(' + index + ')">Remove</button>';
                                html += '</div>';
                            });
                            
                            listDiv.innerHTML = html;
                        }
                
                        function removeExclusionPair(index) {
                            classData.exclusionPairs.splice(index, 1);
                            displayExclusionPairs();
                            updateStep3Status();
                        }
                
                        function updateStep3Status() {
                            var status = document.getElementById('step3Status');
                            if (classData.exclusionPairs.length > 0) {
                                status.style.display = 'block';
                                status.className = 'status-text info';
                                status.innerHTML = '🚫 ' + classData.exclusionPairs.length + ' exclusion pairs set';
                            } else {
                                status.style.display = 'none';
                            }
                        }
                
                        function skipStep3() {
                            classData.exclusionPairs = [];
                            completeStep3();
                        }
                
                        function completeStep3() {
                            // Update step 3 status
                            var status = document.getElementById('step3Status');
                            status.className = 'status-text success';
                            if (classData.exclusionPairs.length > 0) {
                                status.innerHTML = '<span class="checkmark">✓</span> ' + classData.exclusionPairs.length + ' exclusion pairs set';
                            } else {
                                status.innerHTML = '<span class="checkmark">✓</span> No exclusion pairs set';
                            }
                            
                            // Mark step 3 complete and activate step 4
                            document.getElementById('step3').classList.remove('active');
                            document.getElementById('step3').classList.add('completed');
                            document.getElementById('step3').querySelector('.step-number').innerHTML = '✓';
                            
                            document.getElementById('step4').classList.remove('disabled');
                            document.getElementById('step4').classList.add('active');
                            
                            // Populate step 4
                            populateAbsentSelect();
                        }
                            var select = document.getElementById('absentSelect');
                            select.style.display = 'block';
                            select.innerHTML = '';
                            
                            classData.allStudents.forEach(function(student, index) {
                                var div = document.createElement('div');
                                div.className = 'select-item';
                                div.innerHTML = 
                                    '<input type="checkbox" id="absent_' + index + '" onchange="updateAbsentSelection()">' +
                                    '<span>' + student + '</span>';
                                div.addEventListener('click', function(e) {
                                    if (e.target.type !== 'checkbox') {
                                        var checkbox = this.querySelector('input[type="checkbox"]');
                                        checkbox.checked = !checkbox.checked;
                                        updateAbsentSelection();
                                    }
                                });
                                select.appendChild(div);
                            });
                        }
                
                        function updateAbsentSelection() {
                            var checkboxes = document.querySelectorAll('#absentSelect input[type="checkbox"]');
                            var selectedStudents = [];
                            
                            checkboxes.forEach(function(checkbox, index) {
                                var item = checkbox.closest('.select-item');
                                if (checkbox.checked) {
                                    selectedStudents.push(classData.allStudents[index]);
            
            classData.absentStudents = selectedStudents;
            
            var status = document.getElementById('step4Status');
            if (selectedStudents.length > 0) {
                status.style.display = 'block';
                status.className = 'status-text info';
                status.innerHTML = '👻 ' + selectedStudents.length + ' students marked as absent/late';
            } else {
                status.style.display = 'none';
            }
        }

        function skipStep4() {
            classData.absentStudents = [];
            completeStep4();
        }

        function completeStep4() {
            classData.absentPlacement = document.getElementById('absentPlacement').value;
            
            // Update step 4 status
            var status = document.getElementById('step4Status');
            status.className = 'status-text success';
            if (classData.absentStudents.length > 0) {
                status.innerHTML = '<span class="checkmark">✓</span> ' + classData.absentStudents.length + ' absent students will be placed in ' + classData.absentPlacement + ' groups';
            } else {
                status.innerHTML = '<span class="checkmark">✓</span> All students present';
            }
            
            // Mark step 4 complete and activate step 5
            document.getElementById('step4').classList.remove('active');
            document.getElementById('step4').classList.add('completed');
            document.getElementById('step4').querySelector('.step-number').innerHTML = '✓';
            
            document.getElementById('step5').classList.remove('disabled');
            document.getElementById('step5').classList.add('active');
            
            // Populate summary
            populateSummary();
        }

        function populateSummary() {
            var summaryBox = document.getElementById('summaryBox');
            var presentStudents = classData.allStudents.filter(function(s) {
                return !classData.absentStudents.includes(s);
            });
            
            var html = '<h4 style="margin-bottom: 15px; color: #333;">Summary</h4>';
            
            html += '<div class="summary-item">';
            html += '<span>Total Students:</span>';
            html += '<span><strong>' + classData.allStudents.length + '</strong></span>';
            html += '</div>';
            
            html += '<div class="summary-item">';
            html += '<span>Present Students:</span>';
            html += '<span><strong>' + presentStudents.length + '</strong></span>';
            html += '</div>';
            
            if (classData.excludedStudents.length > 0) {
                html += '<div class="summary-item">';
                html += '<span>Can\'t be first ' + classData.exclusionCount + ':</span>';
                html += '<div>';
                classData.excludedStudents.forEach(function(student) {
                    html += '<span class="tag exclusion">' + student + '</span>';
                });
                html += '</div>';
                html += '</div>';
            }
            
            if (classData.exclusionPairs.length > 0) {
                html += '<div class="summary-item">';
                html += '<span>Exclusion Pairs:</span>';
                html += '<div>';
                classData.exclusionPairs.forEach(function(pair) {
                    html += '<span class="tag exclusion">' + pair[0] + ' ↔ ' + pair[1] + '</span>';
                });
                html += '</div>';
                html += '</div>';
            }
            
            if (classData.absentStudents.length > 0) {
                html += '<div class="summary-item">';
                html += '<span>Absent/Late:</span>';
                html += '<div>';
                classData.absentStudents.forEach(function(student) {
                    html += '<span class="tag absent">' + student + '</span>';
                });
                html += '</div>';
                html += '</div>';
            }
            
            summaryBox.innerHTML = html;
        }

        // Shuffle array (Fisher-Yates algorithm)
        function shuffleArray(array) {
            var shuffled = array.slice();
            for (var i = shuffled.length - 1; i > 0; i--) {
                var j = Math.floor(Math.random() * (i + 1));
                var temp = shuffled[i];
                shuffled[i] = shuffled[j];
                shuffled[j] = temp;
            }
            return shuffled;
        }

        // Calculate optimal group distribution
        function calculateOptimalGroups(totalItems, targetGroupSize) {
            if (targetGroupSize >= totalItems) {
                return [totalItems];
            }
            
            var numGroups = Math.ceil(totalItems / targetGroupSize);
            var baseSize = Math.floor(totalItems / numGroups);
            var remainder = totalItems % numGroups;
            
            var groupSizes = [];
            for (var i = 0; i < numGroups; i++) {
                groupSizes.push(baseSize + (i < remainder ? 1 : 0));
            }
            
            return groupSizes;
        }

        // Check if arrangement satisfies constraints
        function satisfiesConstraints(arrangement) {
            // Check position exclusions
            for (var i = 0; i < classData.excludedStudents.length; i++) {
                var student = classData.excludedStudents[i];
                var position = arrangement.indexOf(student);
                if (position !== -1 && position < classData.exclusionCount) {
                    return false;
                }
            }
            
            // Check exclusion pairs
            var groupSizes = calculateOptimalGroups(arrangement.length, classData.groupSize);
            var currentIndex = 0;
            
            for (var g = 0; g < groupSizes.length; g++) {
                var groupSize = groupSizes[g];
                var groupMembers = arrangement.slice(currentIndex, currentIndex + groupSize);
                
                // Check if any exclusion pair is in this group
                for (var p = 0; p < classData.exclusionPairs.length; p++) {
                    var pair = classData.exclusionPairs[p];
                    var student1 = pair[0];
                    var student2 = pair[1];
                    if (groupMembers.includes(student1) && groupMembers.includes(student2)) {
                        return false;
                    }
                }
                
                currentIndex += groupSize;
            }
            
            return true;
        }

        function arrangeWithAbsentStudents(presentArrangement, absentStudents) {
            if (absentStudents.length === 0) {
                return presentArrangement;
            }
            
            var shuffledAbsent = shuffleArray(absentStudents);
            
            switch (classData.absentPlacement) {
                case 'last':
                    // Smart distribution: place absent students backwards through groups
                    var groupSizes = calculateOptimalGroups(presentArrangement.length, classData.groupSize);
                    var result = presentArrangement.slice();
                    
                    // Calculate insertion points (working backwards from the end)
                    var insertionPoints = [];
                    var currentPos = result.length;
                    
                    // Work backwards through groups to create insertion points
                    for (var i = groupSizes.length - 1; i >= 0; i--) {
                        insertionPoints.unshift(currentPos);
                        currentPos -= groupSizes[i];
                    }
                    
                    // Distribute absent students backwards through groups
                    shuffledAbsent.forEach(function(student, index) {
                        var groupIndex = (groupSizes.length - 1) - (index % groupSizes.length);
                        var insertPos = insertionPoints[groupIndex];
                        result.splice(insertPos, 0, student);
                        
                        // Update subsequent insertion points
                        for (var j = groupIndex; j < insertionPoints.length; j++) {
                            insertionPoints[j]++;
                        }
                    });
                    
                    return result;
                    
                case 'spread':
                    // Interleave absent students throughout
                    var spreadResult = presentArrangement.slice();
                    var step = Math.ceil(spreadResult.length / shuffledAbsent.length);
                    shuffledAbsent.forEach(function(student, index) {
                        var insertPos = Math.min(spreadResult.length, (index + 1) * step);
                        spreadResult.splice(insertPos, 0, student);
                    });
                    return spreadResult;
                    
                case 'separate':
                default:
                    return presentArrangement.concat(shuffledAbsent);
            }
        }

        // Generate groups
        function generateGroups() {
            // Always read current settings
            classData.groupSize = parseInt(document.getElementById('groupSize').value) || 3;
            classData.absentPlacement = document.getElementById('absentPlacement').value;
            classData.exclusionCount = parseInt(document.getElementById('exclusionCount').value) || 4;
            
            // Re-read excluded students from current selections
            var excludedCheckboxes = document.querySelectorAll('#exclusionSelect input[type="checkbox"]:checked');
            classData.excludedStudents = Array.from(excludedCheckboxes).map(function(checkbox) {
                var allCheckboxes = document.querySelectorAll('#exclusionSelect input[type="checkbox"]');
                var checkboxIndex = Array.from(allCheckboxes).indexOf(checkbox);
                return classData.allStudents[checkboxIndex];
            });
            
            // Re-read absent students from current selections
            var absentCheckboxes = document.querySelectorAll('#absentSelect input[type="checkbox"]:checked');
            classData.absentStudents = Array.from(absentCheckboxes).map(function(checkbox) {
                var allCheckboxes = document.querySelectorAll('#absentSelect input[type="checkbox"]');
                var checkboxIndex = Array.from(allCheckboxes).indexOf(checkbox);
                return classData.allStudents[checkboxIndex];
            });
            
            var btn = document.getElementById('generateBtn');
            btn.innerHTML = '🎲 Generating... <div class="spinner"></div>';
            btn.disabled = true;
            
            setTimeout(function() {
                try {
                    var presentStudents = classData.allStudents.filter(function(s) {
                        return !classData.absentStudents.includes(s);
                    });
                    var absentStudents = classData.absentStudents;
                    
                    var arrangement;
                    var attempts = 0;
                    var maxAttempts = 1000;
                    
                    // Try to find valid arrangement for present students
                    do {
                        arrangement = shuffleArray(presentStudents);
                        attempts++;
                    } while (!satisfiesConstraints(arrangement) && attempts < maxAttempts);
                    
                    if (attempts >= maxAttempts) {
                        showMessage('Could not find arrangement satisfying all constraints. Try relaxing some constraints.', 'error');
                        return;
                    }
                    
                    // Add absent students according to placement preference
                    var finalArrangement = arrangeWithAbsentStudents(arrangement, absentStudents);
                    
                    displayResults(finalArrangement);
                    showMessage('Successfully randomized ' + classData.allStudents.length + ' students with ' + attempts + ' attempts!', 'info');
                    
                } catch (error) {
                    showMessage('Error during randomization: ' + error.message, 'error');
                } finally {
                    btn.innerHTML = '🎲 Generate Randomized Groups';
                    btn.disabled = false;
                }
            }, 100);
        }

        // Display results
        function displayResults(arrangement) {
            var grid = document.getElementById('resultsGrid');
            grid.innerHTML = '';
            
            if (classData.groupSize === 1) {
                // Simple list
                var group = document.createElement('div');
                group.className = 'result-group';
                var listHtml = '<div class="group-title">Randomized List</div><ul class="group-items">';
                arrangement.forEach(function(item, index) {
                    var isAbsent = classData.absentStudents.includes(item);
                    listHtml += '<li class="' + (isAbsent ? 'absent' : '') + '">' + (index + 1) + '. ' + item + (isAbsent ? ' (absent)' : '') + '</li>';
                });
                listHtml += '</ul>';
                group.innerHTML = listHtml;
                grid.appendChild(group);
            } else {
                // Calculate optimal group sizes
                var groupSizes = calculateOptimalGroups(arrangement.length, classData.groupSize);
                
                var currentIndex = 0;
                groupSizes.forEach(function(size, groupIndex) {
                    var groupItems = arrangement.slice(currentIndex, currentIndex + size);
                    currentIndex += size;
                    
                    var group = document.createElement('div');
                    group.className = 'result-group';
                    
                    var absentCount = groupItems.filter(function(item) {
                        return classData.absentStudents.includes(item);
                    }).length;
                    var presentCount = size - absentCount;
                    
                    var groupHtml = '<div class="group-title">Group ' + (groupIndex + 1) + ' (' + presentCount + ' present' + (absentCount > 0 ? ', ' + absentCount + ' absent' : '') + ')</div>';
                    groupHtml += '<ul class="group-items">';
                    groupItems.forEach(function(item) {
                        var isAbsent = classData.absentStudents.includes(item);
                        groupHtml += '<li class="' + (isAbsent ? 'absent' : '') + '">' + item + (isAbsent ? ' (absent)' : '') + '</li>';
                    });
                    groupHtml += '</ul>';
                    group.innerHTML = groupHtml;
                    grid.appendChild(group);
                });
            }
            
            document.getElementById('resultsSection').style.display = 'block';
        }

        // Copy results to clipboard for Excel
        function copyToExcel() {
            var grid = document.getElementById('resultsGrid');
            var groups = grid.querySelectorAll('.result-group');
            
            var excelText = '';
            
            groups.forEach(function(group) {
                var items = group.querySelectorAll('.group-items li');
                items.forEach(function(item) {
                    // Remove numbering and absent markers for clean Excel data
                    var text = item.textContent;
                    text = text.replace(/^\d+\.\s*/, ''); // Remove "1. " prefix
                    text = text.replace(/\s*\(absent\)\s*$/, ''); // Remove "(absent)" suffix
                    excelText += text + '\n';
                });
            });
            
            navigator.clipboard.writeText(excelText.trim()).then(function() {
                showMessage('List copied to clipboard! You can paste it into Excel.', 'info');
            }).catch(function() {
                // Fallback for older browsers
                var textArea = document.createElement('textarea');
                textArea.value = excelText.trim();
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                showMessage('List copied to clipboard! You can paste it into Excel.', 'info');
            });
        }

        // Show message
        function showMessage(text, type) {
            var container = document.getElementById('messagesContainer');
            var message = document.createElement('div');
            message.className = type === 'error' ? 'error-message' : 'info-message';
            message.textContent = text;
            
            container.innerHTML = '';
            container.appendChild(message);
            
            setTimeout(function() {
                if (message.parentNode) {
                    message.parentNode.removeChild(message);
                }
            }, 5000);
        }

        // Update group size when changed
        document.getElementById('groupSize').addEventListener('change', function() {
            var value = parseInt(this.value);
            if (value < 1) this.value = 1;
        });
    </script>
</body>
</html>
